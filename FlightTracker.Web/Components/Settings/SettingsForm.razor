@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Components
@using FlightTracker.Domain.Enums
@inject Radzen.NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject IJSRuntime JS
@inject IAntiforgery Antiforgery
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@code {
    private class ProfileModel
    {
        public string FullName { get; set; } = string.Empty;
        public string UserName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }

    private class PasswordModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmNewPassword { get; set; } = string.Empty;
    }

    private ProfileModel profile = new();
    private PasswordModel pwd = new();
    private string visibility = "private";
    private bool isPublic;
    private string theme = "system";
    
    // Display & Units
    private DistanceUnit distanceUnit = DistanceUnit.Miles;
    private TemperatureUnit temperatureUnit = TemperatureUnit.Celsius;
    private TimeFormat timeFormat = TimeFormat.TwentyFourHour;
    private DateFormat dateFormat = DateFormat.YearMonthDay;
    
    // Privacy & Sharing
    private ProfileVisibilityLevel profileVisibilityLevel = ProfileVisibilityLevel.Private;
    private bool showTotalMiles = true;
    private bool showAirlines = true;
    private bool showCountries = true;
    private bool showMapRoutes = true;
    private bool enableActivityFeed = false;
    
    private record Option(string Text, string Value);
    private IReadOnlyList<Option> visibilityOptions = new[] { new Option("Public", "public"), new Option("Private", "private") };
    private IReadOnlyList<string> themeOptions = new[] { "system", "light", "dark" };
    private IReadOnlyList<Option<DistanceUnit>> distanceUnitOptions = new[]
    {
        new Option<DistanceUnit>("Miles (mi)", DistanceUnit.Miles),
        new Option<DistanceUnit>("Kilometers (km)", DistanceUnit.Kilometers),
        new Option<DistanceUnit>("Nautical Miles (NM)", DistanceUnit.NauticalMiles)
    };
    private IReadOnlyList<Option<TemperatureUnit>> temperatureUnitOptions = new[]
    {
        new Option<TemperatureUnit>("Celsius (°C)", TemperatureUnit.Celsius),
        new Option<TemperatureUnit>("Fahrenheit (°F)", TemperatureUnit.Fahrenheit)
    };
    private IReadOnlyList<Option<TimeFormat>> timeFormatOptions = new[]
    {
        new Option<TimeFormat>("24-hour (14:30)", TimeFormat.TwentyFourHour),
        new Option<TimeFormat>("12-hour (2:30 PM)", TimeFormat.TwelveHour)
    };
    private IReadOnlyList<Option<DateFormat>> dateFormatOptions = new[]
    {
        new Option<DateFormat>("DD/MM/YYYY (25/12/2025)", DateFormat.DayMonthYear),
        new Option<DateFormat>("MM/DD/YYYY (12/25/2025)", DateFormat.MonthDayYear),
        new Option<DateFormat>("YYYY-MM-DD (2025-12-25)", DateFormat.YearMonthDay)
    };
    
    private record Option<T>(string Text, T Value);

    [Parameter]
    public string FullName { get; set; } = string.Empty;

    [Parameter]
    public string UserName { get; set; } = string.Empty;

    [Parameter]
    public string Email { get; set; } = string.Empty;

    [Parameter]
    public string ProfileVisibility { get; set; } = "private";

    [Parameter]
    public string Theme { get; set; } = "system";
    
    [Parameter]
    public DistanceUnit DistanceUnit { get; set; } = DistanceUnit.Miles;
    
    [Parameter]
    public TemperatureUnit TemperatureUnit { get; set; } = TemperatureUnit.Celsius;
    
    [Parameter]
    public TimeFormat TimeFormat { get; set; } = TimeFormat.TwentyFourHour;
    
    [Parameter]
    public DateFormat DateFormat { get; set; } = DateFormat.YearMonthDay;
    
    [Parameter]
    public ProfileVisibilityLevel ProfileVisibilityLevel { get; set; } = ProfileVisibilityLevel.Private;
    
    [Parameter]
    public bool ShowTotalMiles { get; set; } = true;
    
    [Parameter]
    public bool ShowAirlines { get; set; } = true;
    
    [Parameter]
    public bool ShowCountries { get; set; } = true;
    
    [Parameter]
    public bool ShowMapRoutes { get; set; } = true;
    
    [Parameter]
    public bool EnableActivityFeed { get; set; } = false;

    protected override void OnParametersSet()
    {
        profile.FullName = FullName ?? string.Empty;
        profile.UserName = UserName ?? string.Empty;
        profile.Email = Email ?? string.Empty;
        visibility = string.IsNullOrWhiteSpace(ProfileVisibility) ? "private" : ProfileVisibility;
        theme = string.IsNullOrWhiteSpace(Theme) ? "system" : Theme;
        isPublic = string.Equals(visibility, "public", StringComparison.OrdinalIgnoreCase);
        
        // Set display & units
        distanceUnit = DistanceUnit;
        temperatureUnit = TemperatureUnit;
        timeFormat = TimeFormat;
        dateFormat = DateFormat;
        
        // Set privacy & sharing
        profileVisibilityLevel = ProfileVisibilityLevel;
        showTotalMiles = ShowTotalMiles;
        showAirlines = ShowAirlines;
        showCountries = ShowCountries;
        showMapRoutes = ShowMapRoutes;
        enableActivityFeed = EnableActivityFeed;
    }

    private async Task SaveProfileAsync()
    {
        var data = new { FullName = profile.FullName, UserName = profile.UserName, Email = profile.Email };
        var result = await SubmitFormAsync("/Settings/UpdateProfile", data);
        
        if (result.Success)
        {
            await NotifyAsync("Profile updated successfully", Radzen.NotificationSeverity.Success);
            // Refresh page to update all displayed data with new values from server
            await Task.Delay(500);
            await JS.InvokeVoidAsync("location.reload");
        }
        else if (result.Errors?.Count > 0)
        {
            var errorMessage = string.Join("; ", result.Errors);
            await NotifyAsync(errorMessage, Radzen.NotificationSeverity.Error);
        }
        else
        {
            await NotifyAsync("Failed to update profile", Radzen.NotificationSeverity.Error);
        }
    }

    private async Task ChangePasswordAsync()
    {
        if (pwd.NewPassword != pwd.ConfirmNewPassword)
        {
            await NotifyAsync("New passwords do not match", Radzen.NotificationSeverity.Warning);
            return;
        }

        var data = new
        {
            CurrentPassword = pwd.CurrentPassword,
            NewPassword = pwd.NewPassword,
            ConfirmNewPassword = pwd.ConfirmNewPassword
        };
        
        var result = await SubmitFormAsync("/Settings/ChangePassword", data);
        
        if (result.Success)
        {
            pwd = new();
            await NotifyAsync("Password changed successfully", Radzen.NotificationSeverity.Success);
        }
        else if (result.Errors?.Count > 0)
        {
            var errorMessage = string.Join("; ", result.Errors);
            await NotifyAsync(errorMessage, Radzen.NotificationSeverity.Error);
        }
        else
        {
            await NotifyAsync("Failed to change password", Radzen.NotificationSeverity.Error);
        }
    }

    private async Task SavePreferencesAsync()
    {
        visibility = isPublic ? "public" : "private";
        
        var data = new
        {
            Theme = theme,
            ProfileVisibility = visibility,
            DistanceUnit = (int)distanceUnit,
            TemperatureUnit = (int)temperatureUnit,
            TimeFormat = (int)timeFormat,
            DateFormat = (int)dateFormat,
            ProfileVisibilityLevel = (int)profileVisibilityLevel,
            ShowTotalMiles = showTotalMiles,
            ShowAirlines = showAirlines,
            ShowCountries = showCountries,
            ShowMapRoutes = showMapRoutes,
            EnableActivityFeed = enableActivityFeed
        };
        var result = await SubmitFormAsync("/Settings/UpdatePreferences", data);
        
        if (result.Success)
        {
            await ApplyThemeAsync(theme);
            await NotifyAsync("Preferences saved successfully", Radzen.NotificationSeverity.Success);
        }
        else if (result.Errors?.Count > 0)
        {
            var errorMessage = string.Join("; ", result.Errors);
            await NotifyAsync(errorMessage, Radzen.NotificationSeverity.Error);
        }
        else
        {
            await NotifyAsync("Failed to save preferences", Radzen.NotificationSeverity.Error);
        }
    }

    private async Task<(bool Success, List<string>? Errors, string? DisplayName)> SubmitFormAsync(string url, object data)
    {
        try
        {
            var httpContext = HttpContextAccessor.HttpContext;
            if (httpContext == null)
            {
                return (false, new List<string> { "Unable to access HTTP context" }, null);
            }

            var tokens = Antiforgery.GetAndStoreTokens(httpContext);
            var token = tokens.RequestToken ?? string.Empty;

            var result = await JS.InvokeAsync<System.Text.Json.JsonElement>(
                "FlightTracker.submitForm",
                url,
                token,
                data
            );

            var success = result.GetProperty("success").GetBoolean();
            List<string>? errors = null;
            string? displayName = null;

            if (result.TryGetProperty("errors", out var errorsElement))
            {
                errors = new List<string>();
                if (errorsElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                {
                    foreach (var error in errorsElement.EnumerateArray())
                    {
                        if (error.ValueKind == System.Text.Json.JsonValueKind.String)
                        {
                            errors.Add(error.GetString() ?? "Unknown error");
                        }
                    }
                }
            }

            if (result.TryGetProperty("displayName", out var displayNameElement))
            {
                if (displayNameElement.ValueKind == System.Text.Json.JsonValueKind.String)
                {
                    displayName = displayNameElement.GetString();
                }
            }

            return (success, errors, displayName);
        }
        catch (Exception ex)
        {
            return (false, new List<string> { $"Unexpected error: {ex.Message}" }, null);
        }
    }

    private async Task ApplyThemeAsync(string value)
    {
        await JS.InvokeVoidAsync("FlightTracker.applyTheme", value);
    }

    private Task NotifyAsync(string message, Radzen.NotificationSeverity severity)
    {
        NotificationService.Notify(new Radzen.NotificationMessage { Summary = message, Severity = severity, Duration = 2500 });
        return Task.CompletedTask;
    }
}

<RadzenDialog />
<RadzenNotification />

<RadzenTabs>
    <Tabs>
        <RadzenTabsItem Text="Profile">
            <div class="settings-form">
                <div class="settings-form__row">
                    <label class="rz-label">Full Name</label>
                    <RadzenTextBox @bind-Value="profile.FullName" Style="width: 100%" />
                </div>
                <div class="settings-form__row">
                    <label class="rz-label">Username</label>
                    <RadzenTextBox @bind-Value="profile.UserName" Style="width: 100%" />
                </div>
                <div class="settings-form__row">
                    <label class="rz-label">Email</label>
                    <RadzenTextBox @bind-Value="profile.Email" Style="width: 100%" />
                </div>
                <RadzenButton Text="Save profile" Click="@(_ => SaveProfileAsync())" ButtonStyle="ButtonStyle.Primary" Icon="save" />
            </div>
    </RadzenTabsItem>

    <RadzenTabsItem Text="Password">
            <div class="settings-form">
                <div class="settings-form__row">
                    <label class="rz-label">Current password</label>
                    <RadzenPassword @bind-Value="pwd.CurrentPassword" Style="width: 100%" />
                </div>
                <div class="settings-form__row">
                    <label class="rz-label">New password</label>
                    <RadzenPassword @bind-Value="pwd.NewPassword" Style="width: 100%" />
                </div>
                <div class="settings-form__row">
                    <label class="rz-label">Confirm new password</label>
                    <RadzenPassword @bind-Value="pwd.ConfirmNewPassword" Style="width: 100%" />
                </div>
                <RadzenButton Text="Change password" Click="@(_ => ChangePasswordAsync())" Icon="key" />
            </div>
    </RadzenTabsItem>

    <RadzenTabsItem Text="Preferences">
            <div class="settings-form">
                <div class="settings-form__row">
                    <div class="settings-form__switch-row">
                        <label class="rz-label">Public profile</label>
                        <RadzenSwitch @bind-Value="isPublic" />
                    </div>
                    <small class="settings-form__hint">Toggle to make your profile visible to others.</small>
                </div>

                <div class="settings-form__row">
                    <label class="rz-label">Theme</label>
                    <RadzenDropDown @bind-Value="theme" TValue="string" Data="@themeOptions" Style="width: 100%" />
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--rz-border-color);" />
                
                <h4 style="margin-bottom: 1rem; color: var(--rz-text-color);">Display & Units</h4>
                
                <div class="settings-form__row">
                    <label class="rz-label">Distance unit</label>
                    <RadzenDropDown @bind-Value="distanceUnit" TValue="DistanceUnit" Data="@distanceUnitOptions" TextProperty="Text" ValueProperty="Value" Style="width: 100%" />
                    <small class="settings-form__hint">How distances are displayed on your passport and flight details.</small>
                </div>
                
                <div class="settings-form__row">
                    <label class="rz-label">Temperature unit</label>
                    <RadzenDropDown @bind-Value="temperatureUnit" TValue="TemperatureUnit" Data="@temperatureUnitOptions" TextProperty="Text" ValueProperty="Value" Style="width: 100%" />
                    <small class="settings-form__hint">For weather data (when available).</small>
                </div>
                
                <div class="settings-form__row">
                    <label class="rz-label">Time format</label>
                    <RadzenDropDown @bind-Value="timeFormat" TValue="TimeFormat" Data="@timeFormatOptions" TextProperty="Text" ValueProperty="Value" Style="width: 100%" />
                    <small class="settings-form__hint">How times are displayed throughout the app.</small>
                </div>
                
                <div class="settings-form__row">
                    <label class="rz-label">Date format</label>
                    <RadzenDropDown @bind-Value="dateFormat" TValue="DateFormat" Data="@dateFormatOptions" TextProperty="Text" ValueProperty="Value" Style="width: 100%" />
                    <small class="settings-form__hint">How dates are displayed throughout the app.</small>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--rz-border-color);" />
                
                <h4 style="margin-bottom: 1rem; color: var(--rz-text-color);">Privacy & Sharing</h4>
                
                <div class="settings-form__row">
                    <label class="rz-label">Profile visibility</label>
                    <RadzenDropDown @bind-Value="profileVisibilityLevel" TValue="ProfileVisibilityLevel" 
                        Data="@(new[] { ProfileVisibilityLevel.Private, ProfileVisibilityLevel.Public })"
                        Style="width: 100%" />
                    <small class="settings-form__hint">Who can view your profile and flight statistics.</small>
                </div>
                
                <div class="settings-form__row">
                    <div class="settings-form__switch-row">
                        <label class="rz-label">Show total miles</label>
                        <RadzenSwitch @bind-Value="showTotalMiles" />
                    </div>
                    <small class="settings-form__hint">Display total distance flown on public profile.</small>
                </div>
                
                <div class="settings-form__row">
                    <div class="settings-form__switch-row">
                        <label class="rz-label">Show airlines visited</label>
                        <RadzenSwitch @bind-Value="showAirlines" />
                    </div>
                    <small class="settings-form__hint">Display airline statistics on public profile.</small>
                </div>
                
                <div class="settings-form__row">
                    <div class="settings-form__switch-row">
                        <label class="rz-label">Show countries visited</label>
                        <RadzenSwitch @bind-Value="showCountries" />
                    </div>
                    <small class="settings-form__hint">Display country list on public profile.</small>
                </div>
                
                <div class="settings-form__row">
                    <div class="settings-form__switch-row">
                        <label class="rz-label">Show flight routes on map</label>
                        <RadzenSwitch @bind-Value="showMapRoutes" />
                    </div>
                    <small class="settings-form__hint">Display your flight routes on the public profile map.</small>
                </div>
                
                <div class="settings-form__row">
                    <div class="settings-form__switch-row">
                        <label class="rz-label">Activity feed</label>
                        <RadzenSwitch @bind-Value="enableActivityFeed" />
                    </div>
                    <small class="settings-form__hint">Share when you add new flights (future feature).</small>
                </div>

                <RadzenButton Text="Save preferences" Click="@(_ => SavePreferencesAsync())" Icon="settings" />
            </div>
        </RadzenTabsItem>

        <RadzenTabsItem Text="Export">
            <div class="settings-form">
                <div class="settings-form__row">
                    <p>Download your profile and flights.</p>
                    <div class="settings-form__actions">
                        <RadzenButton Text="Export flights (CSV)" Icon="download" ButtonStyle="ButtonStyle.Secondary" Click="@ExportCsv" />
                        <RadzenButton Text="Export all (JSON)" Icon="download" Click="@ExportAllJson" />
                    </div>
                    <small class="settings-form__hint">Export includes your preferences and flights.</small>
                </div>
            </div>
        </RadzenTabsItem>

        <RadzenTabsItem Text="Danger zone">
            <div class="settings-form">
                <div class="settings-form__row">
                    <p>Delete your profile and all your recorded flights. This cannot be undone.</p>
                    <RadzenButton Text="Delete profile" Icon="delete" ButtonStyle="ButtonStyle.Danger" Click="@ConfirmDeleteProfileAsync" />
                </div>
            </div>
        </RadzenTabsItem>

        <RadzenTabsItem Text="Connections">
            <div class="settings-form">
                <div class="settings-form__row">
                    <p>Connect external data sources (coming soon).</p>
                    <ul>
                        <li>OpenSky Network – view live positions</li>
                        <li>ADS-B Exchange – enrich flight metadata</li>
                        <li>FR24 – historical schedule lookup</li>
                    </ul>
                    <small class="settings-form__hint">This section will allow adding API keys or OAuth connections later.</small>
                </div>
            </div>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

@code {
    private Task ExportCsv() => DownloadAsync("/Settings/Export/Flights.csv");
    private Task ExportAllJson() => DownloadAsync("/Settings/Export/All.json");

    private async Task DownloadAsync(string url)
    {
        try
        {
            await JS.InvokeVoidAsync("eval", "(u=>{var a=document.createElement('a');a.href=u;a.download='';document.body.appendChild(a);a.click();a.remove();})(" + System.Text.Json.JsonSerializer.Serialize(url) + ")");
        }
        catch
        {
            await NotifyAsync("Failed to start download", Radzen.NotificationSeverity.Error);
        }
    }

    private async Task ConfirmDeleteProfileAsync()
    {
        var ok = await DialogService.Confirm(
            "Delete your profile and all recorded flights? This cannot be undone.",
            "Confirm deletion",
            new Radzen.ConfirmOptions
            {
                OkButtonText = "Delete",
                CancelButtonText = "Cancel",
                ShowClose = false
            }
        );
        
        if (ok != true) return;

        var result = await SubmitFormAsync("/Settings/DeleteProfile", new { });
        
        if (result.Success)
        {
            await NotifyAsync("Profile deleted successfully", Radzen.NotificationSeverity.Success);
        }
        else if (result.Errors?.Count > 0)
        {
            var errorMessage = string.Join("; ", result.Errors);
            await NotifyAsync(errorMessage, Radzen.NotificationSeverity.Error);
        }
        else
        {
            await NotifyAsync("Failed to delete profile", Radzen.NotificationSeverity.Error);
        }
    }
}
